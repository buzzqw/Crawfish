variables:
  IMAGE_VERSION: "1.3.6"
  GIT_DEPTH: '3'
  SIMPLECOV: 'true'
  RUST_BACKTRACE: '1'
  RUSTFLAGS: ''
  CARGOFLAGS: ''

stages:
  - prepare-docker
  - build


cache:
  key: '${CI_JOB_NAME}'
  paths:
    - node_modules/
    - packages/*/node_modules/

express:
  image: docker:latest
  stage: prepare-docker
  services:
    - docker:dind
  script:
    - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" docker.io
    - docker pull mauromazzocchetti/webtorrent-express-api:latest
    - docker build --progress=plain --tag="mauromazzocchetti/webtorrent-express-api:$IMAGE_VERSION" --tag="mauromazzocchetti/webtorrent-express-api:latest" ./
    - docker push mauromazzocchetti/webtorrent-express-api:$IMAGE_VERSION
    - docker push mauromazzocchetti/webtorrent-express-api:latest
    - docker logout
  only:
    - main


linux-build:
  stage: build
  image: node:16
  script:
    - npm install
    - electron-builder --linux
  artifacts:
    expire_in: 1 week
    paths:
      - 'packages/fether-electron/dist/*.AppImage'
      - 'packages/fether-electron/dist/*.tar.xz'
      - 'packages/fether-electron/dist/*.snap'
      - 'packages/fether-electron/dist/*.deb'
  only:
    - main

osx-build:
  stage: build
  script:
    - npm install
    - electron-builder --linux
  tags:
    - darwin-shell
  artifacts:
    expire_in: 1 week
    paths:
      - 'packages/fether-electron/dist/*.dmg'
      - 'packages/fether-electron/dist/*.zip'
  only:
    - main

win-build:
  stage: build
  image: electronuserland/builder:wine
  script:
    # Remove the two next lines once the Docker image gets updated to node 12
    # https://github.com/electron-userland/electron-builder/issues/4377
    - npm install -g n
    - n stable
    - npm install
    - electron-builder --win
  artifacts:
    expire_in: 1 week
    paths:
      - 'packages/fether-electron/dist/*.exe'
  only:
    - main
